<section class="content-header">
  <h1>Th·ªëng k√™ doanh thu</h1>
</section>

<section class="content">
  <div class="container">
    <div class="card">
      <div class="card-body">
        <p><strong>T·ªïng doanh thu: </strong> <%= helpers.formatMoney(totalRevenue) %>‚Ç´</p>
        <p><strong>Doanh thu COD (ƒë√£ giao): </strong> <%= helpers.formatMoney(totalCOD) %>‚Ç´</p>
        <p><strong>Doanh thu chuy·ªÉn kho·∫£n: </strong> <%= helpers.formatMoney(totalBank) %>‚Ç´</p>
      </div>

      <form class="form-inline mb-3" method="GET" action="/admin/revenue">
        <label class="mr-2">T·ª´ ng√†y:</label>
        <input type="date" name="from" class="form-control mr-3" value="<%= from %>">

        <label class="mr-2">ƒê·∫øn ng√†y:</label>
        <input type="date" name="to" class="form-control mr-3" value="<%= to %>">

        <button type="submit" class="btn btn-danger">L·ªçc</button>
      </form>

      <div class=" mb-3">
        <a href="/admin/revenue/export/excel" class="btn btn-success">üì• Xu·∫•t Excel</a>
        <button id="downloadChart" class="btn btn-primary my-3">üì∏ Xu·∫•t ·∫£nh bi·ªÉu ƒë·ªì</button>
        <canvas id="revenueChart" height="120"></canvas>
      </div>
    </div>

    <!-- COD Revenue Orders -->
    <div class="card card-info">
      <div class="card-header">
        <h3 class="card-title">ƒê∆°n h√†ng COD (ƒê√£ giao): <%= helpers.formatMoney(totalCOD) %>‚Ç´</h3>
      </div>
      <div class="card-body">
        <table class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>ID ƒë∆°n h√†ng</th>
              <th>Ng√†y t·∫°o</th>
              <th>ID kh√°ch h√†ng</th>
              <th>Kh√°ch h√†ng</th>
              <th>T·ªïng ti·ªÅn</th>
              <th>Tr·∫°ng th√°i</th>
            </tr>
          </thead>
          <tbody>
            <% for (const order of codOrders) { %>
            <tr data-widget="expandable-table" aria-expanded="false">
              <td><%= order.id %></td>
              <td><%= order.created_date %></td>
              <td><%= order.customer_id %></td>
              <td><%= order.shipping_fullname %></td>
              <td><%= helpers.formatMoney(order.orderTotal) %>‚Ç´</td>
              <td><%= order.status.description %></td>
            </tr>
            <tr class="expandable-body">
              <td colspan="11">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>H√¨nh ·∫£nh s·∫£n ph·∫©m</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>Th√†nh ti·ªÅn</th>
                      </tr>
                    </thead>
                    <tbody>
                      <%
                     const orderItems = order.orderItems;
                     for(const orderItem of orderItems){
                       const product = orderItem.product;
                     %>
                      <tr>
                        <td><img class="img-responsive" src="../images/<%= product.featured_image %> " style="width: 60px"></td>
                        <td><%= product.name %></td>
                        <td><%= orderItem.qty %></td>
                        <td><%= helpers.formatMoney(orderItem.unit_price) %>‚Ç´</td>
                        <td><%= helpers.formatMoney(orderItem.total_price) %>‚Ç´</td>
                      </tr>
                      <%}%>
                    </tbody>
                  </table>
                </div>
                <div class="summary">
                  <p><strong>T·∫°m t√≠nh: </strong><%= helpers.formatMoney(order.total_price) %>‚Ç´</p>
                      <p><strong>Ph√≠ v·∫≠n chuy·ªÉn: </strong><%= helpers.formatMoney(order.shipping_fee) %>‚Ç´</p>
                      <p><strong>T·ªïng c·ªông: </strong><%= helpers.formatMoney(order.total_price + order.shipping_fee) %>‚Ç´</p>
                </div>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bank Transfer Orders -->
    <div class="card card-success">
      <div class="card-header">
        <h3 class="card-title">ƒê∆°n h√†ng Chuy·ªÉn kho·∫£n: <%= helpers.formatMoney(totalBank) %>‚Ç´</h3>
      </div>
      <div class="card-body">
        <table class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>ID ƒë∆°n h√†ng</th>
              <th>Ng√†y t·∫°o</th>
              <th>ID kh√°ch h√†ng</th>
              <th>Kh√°ch h√†ng</th>
              <th>T·ªïng ti·ªÅn</th>
              <th>Tr·∫°ng th√°i</th>
            </tr>
          </thead>
          <tbody>
            <% for (const order of bankOrders) { %>
            <tr data-widget="expandable-table" aria-expanded="false">
              <td><%= order.id %></td>
              <td><%= order.created_date %></td>
              <td><%= order.customer_id %></td>
              <td><%= order.shipping_fullname %></td>
              <td><%= helpers.formatMoney(order.orderTotal) %>‚Ç´</td>
              <td><%= order.status.description %></td>
            </tr>
            <tr class="expandable-body">
              <td colspan="11">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>H√¨nh ·∫£nh s·∫£n ph·∫©m</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>Th√†nh ti·ªÅn</th>
                      </tr>
                    </thead>
                    <tbody>
                      <%
                     const orderItems = order.orderItems;
                     for(const orderItem of orderItems){
                       const product = orderItem.product;
                     %>
                      <tr>
                        <td><img class="img-responsive" src="../images/<%= product.featured_image %> " style="width: 60px"></td>
                        <td><%= product.name %></td>
                        <td><%= orderItem.qty %></td>
                        <td><%= helpers.formatMoney(orderItem.unit_price) %>‚Ç´</td>
                        <td><%= helpers.formatMoney(orderItem.total_price) %>‚Ç´</td>
                      </tr>
                      <%}%>
                    </tbody>
                  </table>
                </div>
                <div class="summary">
                  <p><strong>T·∫°m t√≠nh: </strong><%= helpers.formatMoney(order.total_price) %>‚Ç´</p>
                      <p><strong>Ph√≠ v·∫≠n chuy·ªÉn: </strong><%= helpers.formatMoney(order.shipping_fee) %>‚Ç´</p>
                      <p><strong>T·ªïng c·ªông: </strong><%= helpers.formatMoney(order.total_price + order.shipping_fee) %>‚Ç´</p>
                </div>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<script>
  const from = "<%= from || '' %>";
  const to = "<%= to || '' %>";
  let chartInstance = null;

  fetch(`/admin/revenue/chart-data?from=${from}&to=${to}`)
    .then(res => res.json())
    .then(data => {
      const ctx = document.getElementById('revenueChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
              label: 'COD',
              data: data.codValues,
              backgroundColor: 'rgba(255, 99, 132, 0.7)',
              stack: 'Revenue'
            },
            {
              label: 'Chuy·ªÉn kho·∫£n',
              data: data.bankValues,
              backgroundColor: 'rgba(75, 192, 192, 0.7)',
              stack: 'Revenue'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Doanh thu theo ph∆∞∆°ng th·ª©c thanh to√°n'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label;
                  const value = context.formattedValue;

                  if (label === 'COD') {
                    return `COD (Thanh to√°n khi nh·∫≠n h√†ng): ${value}‚Ç´`;
                  } else if (label === 'Chuy·ªÉn kho·∫£n') {
                    return `Chuy·ªÉn kho·∫£n (Bank transfer): ${value}‚Ç´`;
                  }
                  return `${label}: ${value}‚Ç´`;
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                callback: value => value.toLocaleString() + '‚Ç´'
              }
            }
          }
        }
      });
    });

  // Download as image
  document.getElementById('downloadChart').addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = `doanhthu-chart-${Date.now()}.png`;
    link.href = document.getElementById('revenueChart').toDataURL('image/png');
    link.click();
  });
</script>