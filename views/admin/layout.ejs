<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin | BillCipher - Gi·∫£i ph√°p savior cho doanh nghi·ªáp.</title>
  <link rel="icon" href="/favicon.ico" sizes="32x32">
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="/admin/assets/fontawesome-free/css/all.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="/admin/assets/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Toastr -->
  <link rel="stylesheet" href="/admin/assets/toastr/toastr.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/admin/css/adminlte.min.css">
  <!-- my style -->
  <link rel="stylesheet" href="/admin/css/style.css">
  <!-- summerNote -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.css" rel="stylesheet">
  <!-- favicon delete -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ƒêo·∫°n code CSS quay icon */
    .nav-sidebar .menu-is-opening>.nav-link i.right,
    .nav-sidebar .menu-is-opening>.nav-link svg.right,
    .nav-sidebar .menu-open>.nav-link i.right,
    .nav-sidebar .menu-open>.nav-link svg.right {
      -webkit-transform: rotate(90deg);
      transform: rotate(90deg);
    }

    label.error {
      color: red;
      font-weight: normal !important;
    }

    body,
    html {
      font-size: 14px;
    }

    [class*=sidebar-dark-] .nav-treeview>.nav-item>.nav-link.active {
      background: none !important;
      color: #ff6900 !important
    }

    h1 {
      font-size: 25px;
    }
  </style>
</head>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<button id="chatbotToggleMcp" class="btn btn-info" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; border-radius: 50%; width: 60px; height: 60px;">
  ü§ñ
</button>

<button id="chatbotToggleOrder" class="btn btn-warning" style="position: fixed; bottom: 100px; right: 20px; z-index: 9999; border-radius: 50%; width: 60px; height: 60px;">
  üì¶
</button>


<body class="hold-transition dark-mode sidebar-mini layout-fixed layout-navbar-fixed layout-footer-fixed">
  <div class="wrapper">

    <!-- Preloader -->
    <!-- <div class="preloader flex-column justify-content-center align-items-center">
            <img class="animation__wobble" src="public/dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60"
                width="60">
        </div> -->



    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <!-- Brand Logo -->
      <a href="/admin" class="brand-link">
        <img src="/images/BillCipher.png" class="brand-image img-circle elevation-3" style="opacity: .8; border-radius: 0;">
        <!-- <span class="brand-text font-weight-light">AdminLTE 3</span> -->
      </a>
      <!-- <div class="user-panel mt-3 pb-3 mb-3 d-flex"> -->
      <!-- <div class="image">
                <img src="public/dist/img/user2-160x160.jpg" class="img-circle elevation-2" alt="User Image">
            </div> -->

      <!-- </div> -->
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Sidebar user panel (optional) -->



        <!-- SidebarSearch Form -->
        <!-- <div class="form-inline">
            <div class="input-group" data-widget="sidebar-search">
                <input class="form-control form-control-sidebar" type="search" placeholder="Search" aria-label="Search">
                <div class="input-group-append">
                    <button class="btn btn-sidebar">
                        <i class="fas fa-search fa-fw"></i>
                    </button>
                </div>
            </div>
        </div> -->

        <!-- Sidebar Menu -->
        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
            <li class="nav-item">
              <a href="/admin/revenue" class="nav-link <%= currentRoute == 'revenue' ? 'active' : '' %>">
                <i class="nav-icon fas fa-money-bill-wave"></i> <!-- Updated icon for Transport Cost -->
                <p>Qu·∫£n l√≠ doanh thu</p> <!-- Translated label -->
              </a>
            </li>

            <!-- Qu·∫£n l√Ω S·∫£n ph·∫©m -->
            <li class="nav-item">
              <a href="/admin" class="nav-link <%= currentRoute == 'admin' ? 'active' : '' %>">
                <i class="nav-icon fas fa-box"></i>
                <p>Qu·∫£n l√Ω S·∫£n ph·∫©m</p>
              </a>
            </li>

            <li class="nav-item">
              <a href="/admin/brand" class="nav-link <%= currentRoute == 'brand' ? 'active' : '' %>">
                <i class="nav-icon fas fa-trademark"></i>
                <p>Qu·∫£n l√Ω Th∆∞∆°ng Hi√™Ã£u</p>
              </a>
            </li>
            <!-- Qu·∫£n l√Ω Danh m·ª•c -->
            <li class="nav-item">
              <a href="/admin/category" class="nav-link <%= currentRoute == 'category' ? 'active' : '' %>">
                <i class="nav-icon fas fa-tags"></i>
                <p>Qu·∫£n l√Ω Danh m·ª•c</p>
              </a>
            </li>

            <!-- Qu·∫£n l√Ω ƒê∆°n h√†ng -->
            <li class="nav-item">
              <a href="/admin/order" class="nav-link <%= currentRoute == 'order' ? 'active' : '' %>">
                <i class="nav-icon fas fa-shopping-cart"></i>
                <p>Qu·∫£n l√Ω ƒê∆°n h√†ng</p>
              </a>
            </li>

            <li class="nav-item">
              <a href="/admin/status" class="nav-link <%= currentRoute == 'status' ? 'active' : '' %>">
                <i class="nav-icon fas fa-clipboard-list"></i>
                <p>Qu·∫£n l√Ω tr·∫°ng th√°i ƒë∆°n h√†ng</p>
              </a>
            </li>

            <!-- Qu·∫£n l√Ω Kh√°ch h√†ng -->
            <li class="nav-item">
              <a href="/admin/customer" class="nav-link <%= currentRoute == 'customer' ? 'active' : '' %>">
                <i class="nav-icon fas fa-users"></i>
                <p>Qu·∫£n l√Ω Kh√°ch h√†ng</p>
              </a>
            </li>

            <!-- Qu·∫£n l√Ω Nh√¢n vi√™n -->
            <li class="nav-item">
              <a href="/admin/staff" class="nav-link <%= currentRoute == 'staff' ? 'active' : '' %>">
                <i class="nav-icon fas fa-user-tie"></i>
                <p>Qu·∫£n l√Ω Nh√¢n vi√™n</p>
              </a>
            </li>

            <li class="nav-item">
              <a href="/admin/role" class="nav-link <%= currentRoute == 'role' ? 'active' : '' %>">
                <i class="nav-icon fas fa-user-shield"></i>
                <p>Qu·∫£n l√Ω vai tr√≤</p>
              </a>
            </li>

            <li class="nav-item">
              <a href="/admin/action" class="nav-link <%= currentRoute == 'action' ? 'active' : '' %>">
                <i class="nav-icon fas fa-tasks"></i>
                <p>Qu·∫£n l√Ω t√°c v·ª•</p>
              </a>
            </li>

            <!-- Qu·∫£n l√Ω B√¨nh lu·∫≠n -->
            <li class="nav-item">
              <a href="/admin/comment" class="nav-link <%= currentRoute == 'comment' ? 'active' : '' %>">
                <i class="nav-icon fas fa-comment"></i>
                <p>Qu·∫£n l√Ω B√¨nh lu·∫≠n</p>
              </a>
            </li>

            <!-- Manage Staffs -->
            <li class="nav-item">
              <a href="/admin/transport" class="nav-link <%= currentRoute == 'transport' ? 'active' : '' %>">
                <i class="nav-icon fas fa-truck"></i> <!-- Updated icon for Transport Cost -->
                <p>Chi ph√≠ V·∫≠n chuy·ªÉn</p> <!-- Translated label -->
              </a>
            </li>

            <!-- Manage mysql schema -->
            <li class="nav-item">
              <a href="/admin/schema" class="nav-link <%= currentRoute == 'schema' ? 'active' : '' %>">
                <i class="nav-icon fas fa-database"></i>
                <p>Schema MySQL</p>
              </a>
            </li>
          </ul>
        </nav>

        <!-- /.sidebar-menu -->
      </div>
      <!-- /.sidebar -->

    </aside>
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->

      <!-- /.content-header -->

      <!-- Main content -->
      <section class="content">
        <div class="container" style="margin-top:20px;">

          <div class="container" style="margin-top:20px;">
            <div class="info" style="text-align: right;">
              <div class="info" style="top: auto; bottom: 100%;">
                <a href="javascript:void(0)" class="btn-account dropdown-toggle text-white" data-toggle="dropdown" id="dropdownMenu"><%= session.staff_name %></a>
                <ul class=" dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu">
                  <li><a href="?c=users&a=account" class="text-white">Th√¥ng tin t√†i kho·∫£n</a></li>
                  <li role="separator" class="divider"></li>
                  <li><a class="text-white" href="/admin/logout">Tho√°t</a></li>
                </ul>
              </div>
            </div>

            <!-- modal -->
            <!-- .alert.alert-success -->
            <% if (typeof session.message_success !='undefined' ) {%>
            <div class="alert alert-success mt-3 text-center">
              <%=session.message_success%>
              <% delete session.message_success%>
            </div>
            <% } else if (typeof session.message_error !='undefined' ) { %>
            <div class="alert alert-danger mt-3 text-center">
              <%=session.message_error%>
              <% delete session.message_error%>
            </div>
            <% } %>
            <div id="message-ajax">
            </div>
            <%-body%>

            <!-- Main Footer -->
            <!-- <script src="../public/vendor/jquery-3.5.1.min.js"></script>
<script src="../public/vendor/popper.min.js"></script>
<script src="../public/vendor/bootstrap-4.5.3-dist/js/bootstrap.min.js"></script> -->
          </div>
          <!--/. container-fluid -->
      </section>
      <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <!-- Main Footer -->

    <!-- Main Footer -->
    <footer class="main-footer" style="text-align:center;">
      <strong>Copyright &copy; 2024-2025 <a href="#">Bill Cipher</a>.</strong>



    </footer>
    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">B·∫°n mu·ªën x√≥a ph·∫£i kh√¥ng?</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
            <a href="#" class="btn btn-primary">X√°c nh·∫≠n </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ./wrapper -->

  <!-- REQUIRED SCRIPTS -->
  <!-- <script src="public/vendor/jquery-3.5.1.min.js"></script> -->
  <!-- <script src="public/vendor/popper.min.js"></script> -->
  <!-- <script src="public/vendor/bootstrap-4.5.3-dist/js/bootstrap.min.js"></script>  -->




  <!-- jQuery -->
  <script src="/admin/js/jquery-3.6.0.min.js"></script>
  <!-- <script src="/admin/assets/jquery/jquery.min.js"></script> -->
  <!-- Bootstrap -->
  <script src="/admin/assets/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- overlayScrollbars -->
  <script src="/admin/assets/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
  <!-- AdminLTE App -->
  <!-- <script src="/admin/js/jquery-validation-1.19.5/dist/jquery.validate.min.js"></script> -->
  <script src="/admin/js/adminlte.min.js"></script>

  <!-- PAGE PLUGINS -->
  <!-- jQuery Mapael -->
  <script src="/admin/assets/jquery-mousewheel/jquery.mousewheel.js"></script>
  <script src="/admin/assets/raphael/raphael.min.js"></script>
  <script src="/admin/assets/jquery-mapael/jquery.mapael.min.js"></script>
  <script src="/admin/assets/jquery-mapael/maps/usa_states.min.js"></script>
  <!-- ChartJS -->
  <script src="/admin/assets/chart.js/Chart.min.js"></script>

  <!-- AdminLTE for demo purposes -->
  <!-- <script src="/admin/js/demo.js"></script> -->
  <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
  <script src="/admin/js/pages/dashboard2.js"></script>
  <!-- SummerNote -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.js"></script>
  <script src="/admin/assets/jquery-validation/dist/jquery.validate.min.js"></script>

  <!-- <script src="/admin/js/ckeditor.js"></script> -->

  <script src="/admin/js/script.js"></script>

</body>


<!-- Chatbot Modal -->
<div class="modal fade" id="chatbotModal" tabindex="-1" role="dialog" aria-labelledby="chatbotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="chatbotModalLabel">ü§ñ Tr·ª£ l√Ω AI Admin</h5>
        <button id="chatbot-logout-btn" class="btn btn-danger ml-2">Tho√°t</button>
        <button type="button" class="close" data-dismiss="modal" aria-label="ƒê√≥ng">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body" style="padding:0;">

        <!-- Login form -->
        <div id="chatbot-login" style="display:none; padding:20px;">
          <h5>ƒêƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng Chatbot</h5>
          <input type="email" id="chatbot-email" class="form-control mb-2" placeholder="Email" required>
          <input type="password" id="chatbot-pass" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u" required>
          <button id="chatbot-login-btn" class="btn btn-primary w-100">ƒêƒÉng nh·∫≠p</button>
        </div>

        <!-- Chat UI -->
        <div id="chat-section" style="display:none; height:500px; display:flex; flex-direction:column; background:#fff; border-radius:20px; margin:20px; box-shadow:0 0 10px rgba(0,0,0,0.05); overflow:hidden;">
          <div class="chat-header" style="background:#232424; padding:10px; color:white;">
            Chatbot Assistant <span class="badge badge-success">Online</span>
          </div>

          <div id="chat-window" style="flex:1; overflow-y:auto; padding:10px;">
            <div class="text-muted mb-2">Chatbot ƒë√£ s·∫µn s√†ng. V√≠ d·ª•: <i>"H√£y t√≥m t·∫Øt ƒë∆°n h√†ng h√¥m nay"</i></div>
          </div>

          <div style="display:flex; border-top:1px solid #ddd; padding:10px;">
            <input type="text" id="chat-input" class="form-control" placeholder="Nh·∫≠p c√¢u h·ªèi..." style="flex:1; margin-right:10px;">
            <button class="btn btn-primary" id="send-btn">Send</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>


</html>

<script>
  function renderChatHistory(logs) {
    const chatWindow = document.getElementById("chat-window");
    chatWindow.innerHTML = ""; // clear old messages

    logs.forEach(log => {
      appendMessage(log.role, log.content);
    });

    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  const appendMessage = (role, text) => {
    const chatWindow = document.getElementById("chat-window");
    const bubbleStyle = role === "user" ?
      "background: #007bff; color: white; align-self: flex-end;" :
      "background: #585858; color: white; align-self: flex-start;";

    const bubble = `
      <div style="max-width: 80%; margin: 5px 0; padding: 10px 14px; border-radius: 16px; ${bubbleStyle} display: inline-block;">
        ${text}
      </div>
    `;

    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.flexDirection = "column";
    wrapper.innerHTML = bubble;

    chatWindow.appendChild(wrapper);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  };

  const showLoader = () => {
    const chatWindow = document.getElementById("chat-window");
    const loader = document.createElement("div");
    loader.id = "loader";
    loader.style.cssText = "font-style: italic; color: #888; padding-left: 10px; margin: 5px 0;";
    loader.textContent = "ü§ñ Bot ƒëang x·ª≠ l√Ω...";
    chatWindow.appendChild(loader);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  };

  const removeLoader = () => {
    const loader = document.getElementById("loader");
    if (loader) loader.remove();
  };

  document.getElementById("chatbotToggleMcp").addEventListener("click", async function() {
    try {
      const res = await fetch("/admin/chatbot-session-check");
      if (res.ok) {
        // cookie valid ‚Üí show chat
        document.getElementById("chatbot-login").style.display = "none";
        document.getElementById("chat-section").style.display = "flex";

        // ‚úÖ fetch chat history
        const historyRes = await fetch("/admin/chatbot-history");
        if (historyRes.ok) {
          const {
            logs
          } = await historyRes.json();
          renderChatHistory(logs);
        }
      } else {
        // no cookie ‚Üí show login
        document.getElementById("chatbot-login").style.display = "block";
        document.getElementById("chat-section").style.display = "none";
      }
    } catch {
      // fallback ‚Üí login form
      document.getElementById("chatbot-login").style.display = "block";
      document.getElementById("chat-section").style.display = "none";
    }

    $('#chatbotModal').modal('show');
  });


  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : null;
  }

  document.getElementById("chatbot-login-btn").addEventListener("click", async function() {
    const email = document.getElementById("chatbot-email").value.trim();
    const pass = document.getElementById("chatbot-pass").value.trim();
    if (!email || !pass) {
      alert("Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u!");
      return;
    }

    try {
      const res = await fetch("/admin/chatbot-login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          email,
          password: pass
        })
      });

      if (!res.ok) {
        const err = await res.text();
        alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + err);
        return;
      }

      // Login success -> show chat UI (server set cookie httpOnly)
      document.getElementById("chatbot-login").style.display = "none";
      document.getElementById("chat-section").style.display = "flex";
      $('#chatbotModal').modal('show');
    } catch (e) {
      console.error(e);
      alert("L·ªói m·∫°ng khi ƒëƒÉng nh·∫≠p.");
    }
  });


  document.getElementById("send-btn").addEventListener("click", async function() {
    const input = document.getElementById("chat-input");
    const message = input.value.trim();
    if (!message) return;

    appendMessage("user", message);
    input.value = "";

    showLoader();

    try {
      const res = await fetch("/admin/chatbotmcp", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          question: message
        })
      });

      const data = await res.json();

      console.log("Chatbot response:", data);

      removeLoader();
      appendMessage("bot", data.answer);
    } catch (err) {
      removeLoader();
      appendMessage("bot", "‚ùå ƒê√£ x·∫£y ra l·ªói khi g·ªçi chatbot.");
    }
  });

  document.getElementById("chatbot-logout-btn").addEventListener("click", async () => {
    try {
      await fetch("/admin/chatbot/logout", {
        method: "POST"
      });

      // Hide chat and show login
      document.getElementById("chat-section").style.display = "none";
      document.getElementById("chatbot-login").style.display = "block";

      alert("ƒê√£ ƒëƒÉng xu·∫•t.");
    } catch (err) {
      alert("L·ªói khi ƒëƒÉng xu·∫•t");
    }
  });
</script>